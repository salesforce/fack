<% content_for :title, "Documents" %>
<p style="color: green"><%= notice %></p>
<div class="">
  <div class="flex justify-between items-center">
    <h1 class="font-bold text-3xl text-sky-800">Documents</h1>
    <%= link_to 'New', new_document_path, class: "rounded-lg p-2 bg-sky-600 text-white block font-light" %>
  </div>
  <div class="text-sm text-stone-400">
    <% if params[:library_id] %>
      From <%= link_to @library.name, @library, class:"text-sky-500" %>
    <% end %>
  </div>
  <!-- Search Form -->
  <div class="flex-grow flex items-center mt-3">
    <% action_path = @library.present? ? library_documents_path(@library) : documents_path %>
    <%= form_with(url: action_path, method: :get, local: true, class: "w-full flex") do %>
      <input type="text" name="contains" id="contains" placeholder="Search documents..." class="flex-grow rounded-lg p-2 border border-stone-300">
      <button type="submit" class="ml-2 rounded-lg p-2 bg-white text-sky-500 border-sky-500 border">Search</button>
    <% end %>
  </div>
  <div class="flex-grow flex items-center mt-3">
    <% if params[:sort].nil? %>
      <%= link_to 'Sort by Questions', 
            request.original_url.include?('?') ? 
                "#{request.original_url}&sort=questions" : 
                "#{request.original_url}?sort=questions", 
            class: 'rounded-lg p-2 bg-white text-sky-500 border-sky-500 border hover:bg-sky-50' %>
    <% else %>
      <%= link_to 'Sort by Date', request.path, class: 'rounded-lg p-2 bg-white text-sky-500 border-sky-500 border hover:bg-sky-50' %>
    <% end %>
  </div>
  <%= paginate @documents %>
  <ul class="space-y-4">
    <% @documents.each do |document| %>
      <li class="bg-white p-4 rounded shadow group">
        <details class="text-base">
          <summary class="text-md cursor-pointer flex justify-between items-center <%= 'text-red-500' if document.embedding.nil? || document.token_count.nil? %>">
            <div>
              <span><%= document.title %> (<%= document.questions_count %>)</span>
              <div class="text-stone-400 text-xs"><%= time_ago_in_words(document.created_at) %> ago | <%= document.library.name %> </div>
            </div>
            <a href="<%= url_for(document) %>" class="inline-flex items-center text-sky-500 hover:text-sky-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </summary>
          <div class="bg-white p-2 rounded-lg mt-2">
            <% cache document do %>
              <%= render_markdown(document.document.gsub(/^\s*\n/, '')) if document.document %>
            <% end %>
          </div>
        </details>
      </li>
    <% end %>
  </ul>
</div>
